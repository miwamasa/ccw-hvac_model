# ビルエネルギーシミュレーター 利用ガイド

## 目次

1. [システム概要](#システム概要)
2. [起動方法](#起動方法)
3. [基本操作](#基本操作)
4. [詳細機能](#詳細機能)
5. [ワークフロー例](#ワークフロー例)
6. [関連ドキュメント](#関連ドキュメント)

## システム概要

### 機能一覧

| 機能 | 説明 |
|-----|------|
| **設定** | 建物仕様・設備仕様・月別運用条件の編集 |
| **シミュレーション** | エネルギー消費量の計算・予測 |
| **結果表示** | 月別・年間の結果をグラフ表示 |
| **キャリブレーション** | 実測データとの比較・パラメータ自動調整 |
| **設定保存/読込** | JSON形式での設定ファイル管理 |
| **結果保存** | CSV形式でのデータエクスポート |

### 技術スタック

**バックエンド:**
- FastAPI (Python 3.11)
- pandas, numpy, scipy

**フロントエンド:**
- React 18 + TypeScript
- Vite + Tailwind CSS
- Recharts (グラフ表示)

## 起動方法

### 前提条件

- Python 3.11以降
- Node.js 18以降
- pip, npm

### バックエンド起動

```bash
cd backend
pip install -r requirements.txt
python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**起動確認:**
- ブラウザで http://localhost:8000/docs にアクセス
- Swagger UIが表示されればOK

### フロントエンド起動

```bash
cd frontend
npm install
npm run dev
```

**起動確認:**
- ブラウザで http://localhost:3000 にアクセス
- アプリケーション画面が表示されればOK

### Docker Compose起動（オプション）

```bash
docker-compose up -d
```

## 基本操作

### 1. 設定タブ

#### プリセット選択

1. ドロップダウンから「最新オフィス」または「旧式オフィス」を選択
2. 自動的に標準的な設定値がロードされる

**プリセットの違い:**
- **最新オフィス**: 高効率設備（COP 4.5、LED照明）
- **旧式オフィス**: 従来設備（COP 3.0、蛍光灯）

#### 建物仕様の編集

| 項目 | 説明 |
|-----|------|
| 床面積 | オフィスの延床面積 [m²] |
| 天井高 | 天井高さ [m] |
| 壁U値 | 壁の熱貫流率 [W/m²K] - 小さいほど高断熱 |
| 窓面積 | 窓の面積 [m²] |
| 窓U値 | 窓の熱貫流率 [W/m²K] |
| 日射熱取得係数 | 0～1、小さいほど日射を遮蔽 |

#### 設備仕様の編集

| 項目 | 説明 |
|-----|------|
| 照明電力密度 | 単位面積あたりの照明電力 [W/m²] |
| OA機器電力密度 | 単位面積あたりのOA機器電力 [W/m²] |
| 外調機容量 | 外調機の処理能力 [kW] |
| 外調機ファン動力 | ファンの消費電力 [kW] |
| 熱源容量 | チラーの冷却能力 [kW] |
| 熱源COP | 熱源の効率（大きいほど高効率） |
| 個別空調容量 | 個別エアコンの能力 [kW] |
| 個別空調COP | 個別エアコンの効率 |
| 個別空調ファン動力 | ファンの消費電力 [kW] |

#### 月別運用条件の編集

テーブル形式で12ヶ月分を編集:

| 項目 | 説明 |
|-----|------|
| 外気温 | 月平均外気温度 [°C] |
| 外気湿度 | 月平均相対湿度 [%] |
| 室温設定 | 空調設定温度 [°C] |
| 室内湿度設定 | 湿度設定 [%] |
| 給気温度 | 外調機の給気温度 [°C] |
| 居住者数 | 在室人数 [人] |
| 利用率 | オフィスの稼働率 [0～1] |
| 運転時間 | 月間運転時間 [h] |

#### 設定の保存/読込

**保存:**
1. 「設定保存」ボタンをクリック
2. JSON形式でダウンロード
3. ファイル名: `設定名_日時.json`

**読込:**
1. 「設定読込」ボタンをクリック
2. 保存したJSONファイルを選択
3. 設定が自動的にロードされる

### 2. シミュレーションタブ

#### シミュレーション実行

1. 「シミュレーション実行」ボタンをクリック
2. 計算完了を待つ（通常1秒以内）
3. 結果サマリーが表示される

#### 結果サマリー

**表示項目:**
- 年間全館空調消費電力 [kWh]
- 年間個別空調消費電力 [kWh]
- 年間総負荷 [kWh]
- 平均月次負荷 [kW]

### 3. 結果タブ

#### グラフ表示

**月別エネルギー消費グラフ:**
- 全館空調（青線）
- 個別空調（緑線）
- 照明（オレンジ線）
- OA機器（紫線）

**月別負荷グラフ:**
- 顕熱負荷
- 潜熱負荷
- SHF（顕熱比）

#### データエクスポート

1. 「結果保存」ボタンをクリック
2. CSV形式でダウンロード
3. Excelなどで詳細分析が可能

**CSVに含まれるデータ:**
- 月別の全計算結果（30項目以上）
- 負荷内訳
- エネルギー消費内訳

### 4. キャリブレーションタブ

詳細は [キャリブレーション機能ガイド](calibration_guide.md) を参照してください。

#### 基本フロー

1. **実測データ入力**
   - 手動入力またはCSVインポート
2. **比較実行**
   - 「実測と比較」ボタンをクリック
   - グラフとメトリックスで乖離を確認
3. **パラメータ選択**
   - 調整したいパラメータを追加
   - 範囲と分割数を設定
4. **キャリブレーション実行**
   - 方法選択（グリッドサーチ or 統計的最適化）
   - 「キャリブレーション実行」ボタンをクリック
5. **結果確認**
   - 最適パラメータが自動適用
   - 改善度を確認

## 詳細機能

### プリセット機能

#### 最新オフィスの設定値

```
建物仕様:
- 床面積: 1000 m²
- 壁U値: 0.3 W/m²K (高断熱)
- 窓U値: 1.5 W/m²K (Low-E複層ガラス)
- 日射熱取得係数: 0.4

設備仕様:
- 照明: 8 W/m² (LED照明)
- OA機器: 15 W/m²
- 熱源COP: 4.5 (高効率チラー)
- 個別空調COP: 3.5
```

#### 旧式オフィスの設定値

```
建物仕様:
- 床面積: 1000 m²
- 壁U値: 0.8 W/m²K (標準断熱)
- 窓U値: 4.0 W/m²K (単板ガラス)
- 日射熱取得係数: 0.7

設備仕様:
- 照明: 15 W/m² (蛍光灯)
- OA機器: 20 W/m²
- 熱源COP: 3.0 (標準チラー)
- 個別空調COP: 2.8
```

### CSVインポート機能

#### 実測データCSVフォーマット

```csv
month,central_total_kWh,local_total_kWh,total_kWh
1,3200,2800,6000
2,2900,2600,5500
...
```

**注意事項:**
- ヘッダー行は必須
- 欠測値は空欄でOK
- 単位は kWh

#### サンプルCSVファイル

プロジェクトルートの `sample_actual_data.csv` を参照

### 季節別パラメータ

キャリブレーション機能では、運用条件を季節ごとに調整できます:

**季節区分:**
- **冬季**: 11, 12, 1, 2, 3月
- **夏季**: 7, 8, 9月
- **中間期**: 4, 5, 6, 10月

**調整可能:**
- 室温設定
- 室内湿度設定
- 給気温度設定

**メリット:**
- より精密なキャリブレーション
- 季節特性の反映
- 実運用に即した設定

## ワークフロー例

### 例1: 新築ビルの省エネ検討

**目的:** 高効率設備導入の効果を試算

**手順:**

1. **ベースケース作成**
   - プリセット「旧式オフィス」を選択
   - 建物仕様を入力
   - シミュレーション実行
   - 結果を「base_case.csv」として保存

2. **省エネケース作成**
   - プリセット「最新オフィス」を選択
   - 建物仕様は同じ
   - 設備仕様を高効率機器に変更
     - 熱源COP: 3.0 → 4.5
     - 個別空調COP: 2.8 → 3.5
     - 照明: 15 → 8 W/m²
   - シミュレーション実行
   - 結果を「energy_saving.csv」として保存

3. **比較分析**
   - ExcelでCSVを開く
   - 年間消費電力の差を計算
   - 削減率を算出
   - コスト削減額を試算

**期待される結果:**
- エネルギー消費 30～40%削減
- CO₂排出量の大幅削減

### 例2: 既存ビルのキャリブレーション

**目的:** シミュレーションモデルを実測データに合わせる

**手順:**

1. **初期設定**
   - 建物仕様を入力（設計図から）
   - 設備仕様を入力（カタログ値から）
   - 月別条件を入力（BEMSデータから）
   - シミュレーション実行

2. **実測データ準備**
   - 1年分の電力量データを収集
   - CSV形式に整形
   - キャリブレーションタブでインポート

3. **初期比較**
   - 比較対象「合計消費電力」を選択
   - 「実測と比較」をクリック
   - MAPE、R²を確認
   - 例: MAPE = 25%, R² = 0.65

4. **キャリブレーション第1回**
   - パラメータ選択:
     - 熱源COP (3.0～5.0)
     - 個別空調COP (2.5～4.0)
   - 方法: 統計的最適化
   - 実行
   - 結果: MAPE = 15%, R² = 0.85

5. **キャリブレーション第2回**
   - さらにパラメータ追加:
     - 冬季室温設定 (20～24°C)
     - 夏季室温設定 (24～28°C)
   - 実行
   - 結果: MAPE = 8%, R² = 0.92

6. **最終確認**
   - 物理的妥当性をチェック
   - 設定を保存
   - レポート作成

### 例3: 改修効果の予測

**目的:** 窓改修による省エネ効果を予測

**手順:**

1. **現状モデル作成**
   - 実測データでキャリブレーション済み
   - 窓U値: 4.0 W/m²K (単板ガラス)
   - 日射熱取得係数: 0.7

2. **改修ケース1: Low-E複層ガラス**
   - 窓U値: 1.5 W/m²K
   - 日射熱取得係数: 0.4
   - シミュレーション実行
   - 結果保存

3. **改修ケース2: トリプルガラス**
   - 窓U値: 0.9 W/m²K
   - 日射熱取得係数: 0.3
   - シミュレーション実行
   - 結果保存

4. **コスト比較**
   - エネルギー削減量を算出
   - 電気料金削減額を計算
   - 改修コストと比較
   - 投資回収年数を算定

## トラブルシューティング

### シミュレーションエラー

**症状:** 「シミュレーション実行に失敗しました」

**原因と対策:**

1. **入力値が範囲外**
   - → 全ての数値が正の値か確認
   - → COPが1以上か確認

2. **バックエンドが停止**
   - → http://localhost:8000/docs にアクセス
   - → 表示されない場合、バックエンドを再起動

3. **計算エラー**
   - → ブラウザのコンソールでエラー内容確認
   - → 設定値をプリセットに戻してみる

### 比較機能エラー

**症状:** 「比較の実行に失敗しました」

**原因と対策:**

1. **実測データがない**
   - → 最低1ヶ月分のデータを入力

2. **データ形式が不正**
   - → 数値が正しく入力されているか確認
   - → CSVの場合、フォーマットを確認

### キャリブレーションが終わらない

**症状:** ローディングが長時間続く

**対策:**
- パラメータ数を減らす（2～3個）
- 分割数を減らす（5～7）
- グリッドサーチから統計的最適化に変更

### グラフが表示されない

**症状:** 結果タブでグラフが空白

**対策:**
- ブラウザをリロード（Ctrl+R）
- シミュレーションを再実行
- ブラウザのJavaScriptエラーを確認

## 関連ドキュメント

### 計算理論

詳細な計算式と理論は以下を参照:
- [エネルギー計算理論](energy_calculation.md)

**内容:**
- 建物熱負荷計算
- 空調システム計算
- パラメータ説明

### キャリブレーション

キャリブレーション機能の詳細:
- [キャリブレーション機能ガイド](calibration_guide.md)

**内容:**
- アルゴリズム説明
- 評価メトリックス
- パラメータ選択ガイド
- ベストプラクティス

### API仕様

バックエンドAPIの詳細:
- Swagger UI: http://localhost:8000/docs

**主要エンドポイント:**
- `POST /api/v1/simulate`: シミュレーション実行
- `POST /api/v1/compare`: 実測データと比較
- `POST /api/v1/calibrate`: キャリブレーション実行
- `GET /api/v1/presets/modern`: 最新オフィスプリセット取得
- `GET /api/v1/presets/old`: 旧式オフィスプリセット取得

## よくある質問（FAQ）

### Q1: どの程度の精度が期待できますか？

**A:** キャリブレーション後の精度目安:
- MAPE < 10%: 実用上十分
- R² > 0.9: 高精度

実測との乖離要因:
- 気象条件の違い
- 実運用との差異
- モデルの簡略化

### Q2: 計算時間はどのくらいですか？

**A:**
- 通常のシミュレーション: 1秒以内
- グリッドサーチ (3パラメータ×10分割): 5～30秒
- 統計的最適化: 10～60秒

### Q3: 時刻別の計算はできますか？

**A:**
現バージョンは月単位の計算のみ対応しています。
時刻別計算が必要な場合は、専用の動的シミュレーションツール（EnergyPlus等）の使用を推奨します。

### Q4: 他のビル用途にも使えますか？

**A:**
オフィスビルを想定していますが、以下の用途にも応用可能:
- 商業施設（照明・OA機器密度を調整）
- 学校（在室スケジュールを調整）
- 病院（24時間運転に設定）

ただし、特殊な空調方式（例: 手術室、クリーンルーム）には対応していません。

### Q5: 複数ケースの比較機能はありますか？

**A:**
現在は1ケースずつ実行・保存する方式です。
複数ケースの比較は、保存したCSVファイルをExcelなどで比較してください。

将来的には複数ケース一括比較機能を追加予定です。

## サポート

### 問題報告

バグや要望は以下で報告してください:
- GitHubリポジトリのIssue

### ドキュメント更新

ドキュメントの改善提案も歓迎します。

## ライセンス

本ソフトウェアのライセンスについては、プロジェクトルートの `LICENSE` ファイルを参照してください。
